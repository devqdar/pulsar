/*
 *	GetFile v1.1 - 2014-09-19
 *	jQuery Upload Plugin
 *	By Jose Carlos Rodriguez
 *	(c) 2014 Syscover S.L. - http://www.syscover.com/
 *	All rights reserved
 */
"use strict";(function(e){var t={options:{urlPlugin:".",folder:null,tmpFolder:null,encryption:false,filename:null,outputExtension:null,mimesAccept:["image/*","video/*","audio/*","application/pdf","application/msword","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],crop:{active:false,width:null,height:null,aspectRatio:null,minSize:null,maxSize:null,setSelect:null},resize:{active:false,width:null,height:null,constrainProportions:true},sizes:[],lang:{cropWindowTitle:"Cop image",previewTitle:"Preview",cropButtonText:"Crop",cancelButtonText:"Cancel"},selectorItems:{container:"#wrapGetFile",cropButton:"#gfCropButton",cancelButton:"#gfCancelButton",crop:".imgs-crop-container",preview:".imgs-preview-container"}},items:{container:null,cropButton:null,cancelButton:null,crop:null,preview:null},properties:{coords:null,tmpDelete:345600,tmpName:"",oldName:null,extension:null,mime:null,size:null,isImage:null,mow:null,moh:800,mpw:null,mph:800,row:null,roh:null,rpw:null,rph:null,width:null,height:null,pixelRatio:null},callback:null,init:function(t,n,r){this.options=e.extend({},this.options,t||{});if(e(this.options.selectorItems.container).length==0){var i=this.options.lang;i.urlPlugin=t.urlPlugin;e.ajax({async:false,cache:false,dataType:"html",type:"POST",url:this.options.urlPlugin+"/getfile/views/popup.php",data:i,success:function(t){e("body").append(t)},error:function(e){}})}this.items={container:e(this.options.selectorItems.container),cropButton:e(this.options.selectorItems.cropButton),cancelButton:e(this.options.selectorItems.cancelButton),crop:e(this.options.selectorItems.crop),preview:e(this.options.selectorItems.preview)};if(t.mimesAccept){this.options.mimesAccept=t.mimesAccept}this.callback=n;this.elem=e(r);if(this.elem.prop("className").search("btngf-getFile")>-1){var s="input-getfile"}else{var s="input-getfile-alone"}if(this.options.mimesAccept==false){this.elem.append('<input id="inputGetFile" type="file" class="'+s+'">').on("change",e.proxy(this.upload,this))}else{if(Object.prototype.toString.call(this.options.mimesAccept)==="[object Array]"){this.elem.append('<input id="inputGetFile" type="file" class="'+s+'" accept="'+this.options.mimesAccept.join()+'">').on("change",e.proxy(this.upload,this))}else{var o={success:false,error:11,message:"The mimesAccept setting must be an array or false. Setting it to false might be dangerous, since it means accepting all file types"};this.callback(o)}}return this},upload:function(t){e.cssLoader.show({urlPlugin:"/getfile/libs",useLayer:false,theme:"carousel"});var n=new FormData;n.append("action","upload");n.append("file",t.target.files[0]);n.append("folder",this.options.folder);n.append("tmpFolder",this.options.tmpFolder);n.append("cropActive",this.options.crop.active);n.append("resizeActive",this.options.resize.active);n.append("outputExtension",this.options.outputExtension);n.append("encryption",this.options.encryption);n.append("filename",this.options.filename);n.append("mimesAccept",this.options.mimesAccept);n.append("tmpDelete",this.properties.tmpDelete);e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",data:n,type:"POST",dataType:"json",context:this,cache:false,contentType:false,processData:false,success:function(t){this.elem.find("#inputGetFile").val("");this.properties.tmpName=t.name;this.properties.size=t.size;this.properties.oldName=t.oldName;this.properties.extension=t.extension;this.properties.mime=t.mime;this.properties.isImage=t.isImage;if(this.options.crop.active&&t.isImage){this.properties.width=t.width;this.properties.height=t.height;this.properties.pixelRatio=window.devicePixelRatio;e.colorbox({inline:true,href:this.items.container,width:"100%",height:"100%",scrolling:false});var n=e("#cboxLoadedContent"),r=e("#gfPreview"),i=e("#gfFooter"),s=n.width(),o=n.height(),u=false;if(e(window).width()*this.properties.pixelRatio>990){var a=s-70;this.properties.mow=Math.round(a*.7);this.properties.mpw=Math.round(a*.3);u=true}else{var a=s;this.properties.mow=Math.round(a*.9);this.properties.mpw=Math.round(a*.6);u=false}if(!MobileEsp.DetectTierTablet()&&!MobileEsp.DetectTierIphone()){this.properties.moh=o-110}this.crop(this.options.tmpFolder+"/"+t.name);r.removeClass();i.removeClass();if(u){r.addClass("gf-horizontal")}else{r.addClass("gf-vertical");i.addClass("gf-vertical");var f=Math.round(this.properties.mph+this.properties.moh+175);e.colorbox.resize({width:"100%",height:f})}}else if(this.options.resize.active&&t.isImage){this.executeResize()}else if(this.options.outputExtension!=null&&t.isImage){this.executeChangeExtension(t.tmpFolder+"/"+t.name)}else{this.callback(t)}e.cssLoader.hide()}})},crop:function(t){if(!e.Jcrop){var n={success:false,error:3,message:"JCrop library not loaded"};this.callback(n)}this.removeCrop();if(this.options.crop.height&&this.options.crop.width){this.options.crop.aspectRatio=this.options.crop.width/this.options.crop.height}else{if(isNaN(this.options.crop.aspectRatio)){var n={success:false,error:4,message:"Width and Height or Ratio must be defined"};this.callback(n)}}if(this.options.crop.aspectRatio>=1){this.properties.rpw=this.properties.mpw;this.properties.rph=Math.round(this.properties.rpw/this.options.crop.aspectRatio)}else{this.properties.rph=this.properties.mph;this.properties.rpw=Math.round(this.properties.rph*this.options.crop.aspectRatio);if(this.properties.rpw>this.properties.mpw){this.properties.rpw=this.properties.mpw;this.properties.rph=Math.round(this.properties.rpw/this.options.crop.aspectRatio)}}this.properties.mph=this.properties.rph;var r=this.properties.width/this.properties.height;if(this.properties.width>this.properties.mow){this.properties.row=this.properties.mow;this.properties.roh=Math.round(this.properties.mow/r)}else{this.properties.row=this.properties.width;this.properties.roh=this.properties.height}if(this.properties.roh>this.properties.moh){this.properties.roh=this.properties.moh;this.properties.row=Math.round(this.properties.moh*r)}this.properties.moh=this.properties.roh;this.items.preview.css({width:this.properties.rpw+"px",height:this.properties.rph+"px"});this.items.crop.css({width:this.properties.mow+4+"px",height:this.properties.moh+"px"});var i=e('<img id="imgOrig" width="'+this.properties.row+'" height="'+this.properties.roh+'" src="'+t+'">').appendTo(this.items.crop);var s=e('<img id="imgPreview" src="'+t+'">').appendTo(this.items.preview);e("#imgOrig").Jcrop({onChange:e.proxy(this.showPreview,this),onSelect:e.proxy(this.showPreview,this),bgColor:"black",bOpacity:.65,aspectRatio:this.options.crop.aspectRatio,minSize:this.options.crop.minSize,maxSize:this.options.crop.maxSize,setSelect:this.options.crop.setSelect});this.items.cropButton.on("click",e.proxy(this.executeCrop,this));this.items.cancelButton.on("click",function(){e.colorbox.close()})},removeCrop:function(){e(this.items.crop).html("");e(this.items.preview).html("");this.items.cropButton.off("click");this.items.cancelButton.off("click")},showPreview:function(t){var n=this.properties.rpw/t.w;var r=this.properties.rph/t.h;e("#imgPreview").css({width:Math.round(n*e("#imgOrig").width())+"px",height:Math.round(r*e("#imgOrig").height())+"px",marginLeft:"-"+Math.round(n*t.x)+"px",marginTop:"-"+Math.round(r*t.y)+"px"});this.properties.coords=t},executeCrop:function(){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"crop",tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,coords:this.properties.coords,cropWidth:this.options.crop.width,cropHeight:this.options.crop.height,aspectRatio:this.options.crop.aspectRatio,tmpFolder:this.options.tmpFolder,folder:this.options.folder,row:this.properties.row,roh:this.properties.roh,outputExtension:this.options.outputExtension,sizes:this.options.sizes},success:function(t){if(t.success){e.colorbox.close();this.callback(t)}}})},executeResize:function(){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"resize",tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,width:this.options.resize.width,height:this.options.resize.height,constrainProportions:this.options.resize.constrainProportions,outputExtension:this.options.outputExtension,sizes:this.options.sizes},success:function(e){if(e.success){this.callback(e)}}})},executeChangeExtension:function(t){var n=new Image;n.src=t;e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"change",tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,row:this.properties.row,roh:this.properties.roh,outputExtension:this.options.outputExtension},success:function(e){if(e.success){this.callback(e)}}})}};if(typeof Object.create!=="function"){Object.create=function(e){function t(){}t.prototype=e;return new t}}e.fn.getFile=function(n,r){return this.each(function(){if(!e.data(this,"getFile")){e.data(this,"getFile",Object.create(t).init(n,r,this))}})}})(jQuery)